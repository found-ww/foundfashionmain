{%- comment -%}
  Product Story Section
  - Checks if the product has any of the 9 known bag tags.
  - If a tag matches and an article is configured → show the section with that article's image/URL/excerpt.
  - If a tag matches but no article is configured → hide the section entirely.
  - If no matching tag → show the section with the general settings below.
{%- endcomment -%}

{%- assign ps_tagged = false -%}
{%- assign ps_tag_article = blank -%}

{%- for tag in product.tags -%}
  {%- assign ps_tag_lower = tag | downcase -%}
  {%- if ps_tag_lower == 'birkin' -%}
    {%- assign ps_tagged = true -%}
    {%- assign ps_tag_article = section.settings.birkin_article -%}
  {%- elsif ps_tag_lower == 'kelly' -%}
    {%- assign ps_tagged = true -%}
    {%- assign ps_tag_article = section.settings.kelly_article -%}
  {%- elsif ps_tag_lower == 'garden party' -%}
    {%- assign ps_tagged = true -%}
    {%- assign ps_tag_article = section.settings.garden_party_article -%}
  {%- elsif ps_tag_lower == 'picotin' -%}
    {%- assign ps_tagged = true -%}
    {%- assign ps_tag_article = section.settings.picotin_article -%}
  {%- elsif ps_tag_lower == 'herbag' -%}
    {%- assign ps_tagged = true -%}
    {%- assign ps_tag_article = section.settings.herbag_article -%}
  {%- elsif ps_tag_lower == 'medor' or ps_tag_lower == 'médor' -%}
    {%- assign ps_tagged = true -%}
    {%- assign ps_tag_article = section.settings.medor_article -%}
  {%- elsif ps_tag_lower == 'evelyne' -%}
    {%- assign ps_tagged = true -%}
    {%- assign ps_tag_article = section.settings.evelyne_article -%}
  {%- elsif ps_tag_lower == 'tablier' -%}
    {%- assign ps_tagged = true -%}
    {%- assign ps_tag_article = section.settings.tablier_article -%}
  {%- elsif ps_tag_lower == 'bolide' -%}
    {%- assign ps_tagged = true -%}
    {%- assign ps_tag_article = section.settings.bolide_article -%}
  {%- endif -%}
  {%- if ps_tagged -%}{%- break -%}{%- endif -%}
{%- endfor -%}

{%- comment -%} Tagged product with no article configured — hide the whole section {%- endcomment -%}
{%- if ps_tagged and ps_tag_article == blank -%}
  {%- comment -%} Render nothing {%- endcomment -%}
{%- else -%}

{%- comment -%} Story image: article image → section image picker → second product image → first product image {%- endcomment -%}
{%- assign ps_use_picker = false -%}
{%- if ps_tag_article != blank and ps_tag_article.image != blank -%}
  {%- assign ps_use_picker = true -%}
  {%- assign ps_picker_img = ps_tag_article.image -%}
{%- elsif section.settings.image != blank -%}
  {%- assign ps_use_picker = true -%}
  {%- assign ps_picker_img = section.settings.image -%}
{%- else -%}
  {%- assign ps_media = product.media[1] -%}
  {%- if ps_media == blank or ps_media.media_type != 'image' -%}
    {%- assign ps_media = product.media[0] -%}
  {%- endif -%}
{%- endif -%}

{%- comment -%} Story text {%- endcomment -%}
{%- assign ps_text_html = blank -%}
{%- assign ps_text_plain = blank -%}
{%- if ps_tag_article != blank -%}
  {%- if section.settings.medor_article_text != blank and ps_tag_article == section.settings.medor_article -%}
    {%- assign ps_text_plain = section.settings.medor_article_text -%}
  {%- elsif ps_tag_article.excerpt != blank -%}
    {%- assign ps_text_plain = ps_tag_article.excerpt | strip_html | truncatewords: 40 -%}
  {%- endif -%}
{%- elsif section.settings.text != blank -%}
  {%- assign ps_text_html = section.settings.text -%}
{%- elsif product.description != blank -%}
  {%- assign ps_text_plain = product.description | strip_html | truncatewords: 70 -%}
{%- endif -%}

{%- comment -%} Button {%- endcomment -%}
{%- assign ps_btn_label = 'READ MORE' -%}
{%- assign ps_img_link = '' -%}
{%- if ps_tag_article != blank -%}
  {%- assign ps_btn_url = ps_tag_article.url -%}
  {%- assign ps_img_link = ps_tag_article.url -%}
{%- else -%}
  {%- assign ps_btn_url = product.url -%}
  {%- if section.settings.button_text != blank -%}
    {%- assign ps_btn_label = section.settings.button_text -%}
  {%- endif -%}
  {%- if section.settings.button_url != blank -%}
    {%- assign ps_btn_url = section.settings.button_url -%}
  {%- endif -%}
{%- endif -%}

<div class="ps-story" {{ section.shopify_attributes }}>
  <div class="ps-story__cols">
    <div class="ps-story__image">
      {%- if ps_img_link != '' -%}
        <a href="{{ ps_img_link }}" class="ps-story__img-link"></a>
      {%- endif -%}
      {%- if ps_use_picker -%}
        {%- assign ps_picker_url = ps_picker_img | img_url: '1x1' | replace: '_1x1.', '_{width}x.' -%}
        <img class="ps-story__img Image--lazyLoad Image--fadeIn"
             data-src="{{ ps_picker_url }}"
             data-widths="[600, 800, 1000]"
             data-sizes="auto"
             alt="{{ ps_picker_img.alt | default: product.title | escape }}">
        <span class="Image__Loader"></span>
      {%- elsif ps_media and ps_media.media_type == 'image' -%}
        {%- assign ps_media_url = ps_media | img_url: '1x1' | replace: '_1x1.', '_{width}x.' -%}
        <img class="ps-story__img Image--lazyLoad Image--fadeIn"
             data-src="{{ ps_media_url }}"
             data-widths="[600, 800, 1000]"
             data-sizes="auto"
             alt="{{ ps_media.alt | default: product.title | escape }}">
        <span class="Image__Loader"></span>
      {%- endif -%}
    </div>

    <div class="ps-story__content">
      <h2 class="ps-story__heading">DISCOVER THE STORY</h2>
      {%- if ps_text_html != blank -%}
        <div class="ps-story__text Rte">{{ ps_text_html }}</div>
      {%- elsif ps_text_plain != blank -%}
        <div class="ps-story__text">{{ ps_text_plain }}</div>
      {%- endif -%}
      <a href="{{ ps_btn_url }}" class="ps-btn ps-btn--tertiary">{{ ps_btn_label }}</a>
    </div>
  </div>
</div>

{%- endif -%}

<style>
.ps-story {
  min-height: 360px;
  font-family: 'Jost', sans-serif;
  padding-left: 35px;
  padding-right: 35px;
}

.ps-story__cols {
  display: flex;
  min-height: 360px;
}

.ps-story__image {
  flex: 0 0 50%;
  position: relative;
  background: #f0ebe3;
  overflow: hidden;
}

.ps-story__img-link {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  display: block;
  z-index: 1;
}

.ps-story__img {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
}

.ps-story__content {
  flex: 0 0 50%;
  background: rgba(215, 182, 161, 0.15);
  padding: 60px 66px;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
}

.ps-story__heading {
  font-family: 'Jost', sans-serif;
  font-size: 16px;
  font-weight: 400;
  letter-spacing: 0.22em;
  text-transform: uppercase;
  color: #1a1a1a;
  text-align: center;
  margin: 0 0 32px;
}

.ps-story__text {
  font-family: 'Jost', sans-serif;
  font-size: 14px;
  font-weight: 300;
  line-height: 1.9;
  color: #444444;
  text-align: center;
  margin-bottom: 0;
}

.ps-btn {
  display: inline-block;
  font-family: 'Jost', sans-serif;
  font-size: 11px;
  letter-spacing: 0.18em;
  text-transform: uppercase;
  text-decoration: none;
  border-radius: 0;
  white-space: nowrap;
  padding: 14px 24px;
}

.ps-btn--tertiary {
  background: transparent;
  color: #1a1a1a;
  border: 1px solid #1a1a1a;
  margin-top: 28px;
}

.ps-btn--tertiary:hover {
  background: #1a1a1a;
  color: #ffffff;
}

@media screen and (max-width: 900px) {
  .ps-story {
    min-height: auto;
    padding-left: 0;
    padding-right: 0;
  }

  .ps-story__cols {
    flex-direction: column;
    min-height: auto;
  }

  .ps-story__image {
    flex: none;
    height: 70vw;
    min-height: 280px;
  }

  .ps-story__content {
    flex: none;
    padding: 40px 24px;
  }

  .ps-story__heading {
    font-size: 14px;
    margin-bottom: 20px;
  }
}
</style>

{% schema %}
{
  "name": "Product Story",
  "settings": [
    {
      "type": "header",
      "content": "Default Story Panel"
    },
    {
      "type": "paragraph",
      "content": "Used for products with none of the bag tags below."
    },
    {
      "type": "image_picker",
      "id": "image",
      "label": "Story image",
      "info": "Leave blank to use the second product image automatically"
    },
    {
      "type": "richtext",
      "id": "text",
      "label": "Story text",
      "info": "Leave blank to show a truncated product description"
    },
    {
      "type": "text",
      "id": "button_text",
      "label": "Button label",
      "default": "READ MORE"
    },
    {
      "type": "url",
      "id": "button_url",
      "label": "Button link",
      "info": "Leave blank to link to the product page"
    },
    {
      "type": "header",
      "content": "Birkin"
    },
    {
      "type": "article",
      "id": "birkin_article",
      "label": "Birkin blog article",
      "info": "Applied to products tagged 'Birkin'. Leave blank to hide the section for those products."
    },
    {
      "type": "header",
      "content": "Kelly"
    },
    {
      "type": "article",
      "id": "kelly_article",
      "label": "Kelly blog article",
      "info": "Applied to products tagged 'Kelly'. Leave blank to hide the section for those products."
    },
    {
      "type": "header",
      "content": "Garden Party"
    },
    {
      "type": "article",
      "id": "garden_party_article",
      "label": "Garden Party blog article",
      "info": "Applied to products tagged 'Garden Party'. Leave blank to hide the section for those products."
    },
    {
      "type": "header",
      "content": "Picotin"
    },
    {
      "type": "article",
      "id": "picotin_article",
      "label": "Picotin blog article",
      "info": "Applied to products tagged 'Picotin'. Leave blank to hide the section for those products."
    },
    {
      "type": "header",
      "content": "Herbag"
    },
    {
      "type": "article",
      "id": "herbag_article",
      "label": "Herbag blog article",
      "info": "Applied to products tagged 'Herbag'. Leave blank to hide the section for those products."
    },
    {
      "type": "header",
      "content": "Médor"
    },
    {
      "type": "article",
      "id": "medor_article",
      "label": "Médor blog article",
      "info": "Applied to products tagged 'Médor' or 'medor'. Leave blank to hide the section for those products."
    },
    {
      "type": "textarea",
      "id": "medor_article_text",
      "label": "Médor story excerpt (optional override)",
      "info": "Override the article excerpt for Médor products only. Leave blank to use the article's own excerpt."
    },
    {
      "type": "header",
      "content": "Evelyne"
    },
    {
      "type": "article",
      "id": "evelyne_article",
      "label": "Evelyne blog article",
      "info": "Applied to products tagged 'Evelyne'. Leave blank to hide the section for those products."
    },
    {
      "type": "header",
      "content": "Tablier"
    },
    {
      "type": "article",
      "id": "tablier_article",
      "label": "Tablier blog article",
      "info": "Applied to products tagged 'Tablier'. Leave blank to hide the section for those products."
    },
    {
      "type": "header",
      "content": "Bolide"
    },
    {
      "type": "article",
      "id": "bolide_article",
      "label": "Bolide blog article",
      "info": "Applied to products tagged 'Bolide'. Leave blank to hide the section for those products."
    }
  ],
  "presets": [
    {
      "name": "Product Story"
    }
  ]
}
{% endschema %}
